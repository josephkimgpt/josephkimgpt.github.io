<!DOCTYPE html>
<html>
<head>
    <title>Flappy Bird Clone</title>
    <style>
        canvas {
            background-color: #70c5ce;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas" width="320" height="480"></canvas>
<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let frames = 0;

    const state = {
        current: 0,
        getReady: 0,
        game: 1,
        over: 2
    }

    const startBtn = {
        x: 120,
        y: 263,
        w: 83,
        h: 29
    }

    canvas.addEventListener("click", function(evt){
        switch(state.current){
            case state.getReady:
                state.current = state.game;
                break;
            case state.game:
                bird.flap();
                break;
            case state.over:
                let rect = canvas.getBoundingClientRect();
                let clickX = evt.clientX - rect.left;
                let clickY = evt.clientY - rect.top;

                if(clickX >= startBtn.x && clickX <= startBtn.x + startBtn.w &&
                   clickY >= startBtn.y && clickY <= startBtn.y + startBtn.h){
                    pipes.reset();
                    bird.speedReset();
                    score.reset();
                    state.current = state.getReady;
                }
                break;
        }
    });

    const bg = {
        draw: function(){
            ctx.fillStyle = "#70c5ce";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    const fg = {
        y: canvas.height - 112,
        draw: function(){
            ctx.fillStyle = "#000";
            ctx.fillRect(0, this.y, canvas.width, 112);
        },
        update: function(){
            // No vertical movement needed
        }
    }

    const bird = {
        x: 50,
        y: 150,
        width: 34,
        height: 26,
        gravity: 0.25,
        jump: 4.6,
        speed: 0,
        draw: function(){
            ctx.fillStyle = "#FF0"; // Yellow bird
            ctx.fillRect(this.x, this.y, this.width, this.height);
        },
        flap: function(){
            this.speed = - this.jump;
        },
        update: function(){
            this.speed += this.gravity;
            this.y += this.speed;

            if(this.y + this.height >= canvas.height - fg.y){
                this.y = canvas.height - fg.y - this.height;
                if(state.current == state.game){
                    state.current = state.over;
                }
            }
            if(this.y < 0){
                this.y = 0;
            }
        },
        speedReset: function(){
            this.speed = 0;
        }
    }

    const pipes = {
        position: [],
        width: 53,
        height: 400,
        gap: 100,
        maxYPos: -150,
        dx: 2,
        draw: function(){
            for(let i = 0; i < this.position.length; i++){ 
                let p = this.position[i];
                
                // Top pipe
                ctx.fillStyle = "#0F0"; // Green pipe
                ctx.fillRect(p.x, p.y, this.width, this.height);

                // Bottom pipe
                ctx.fillRect(p.x, p.y + this.height + this.gap, this.width, this.height);
            }
        },
        update: function(){
            if(state.current !== state.game) return;

            if(frames % 100 == 0){
                this.position.push({
                    x: canvas.width,
                    y: this.maxYPos * (Math.random() + 1)
                });
            }
            for(let i = 0; i < this.position.length; i++){ 
                let p = this.position[i];

                // Move the pipes to the left
                p.x -= this.dx;

                // If the pipes go beyond canvas, we delete them from the array
                if(p.x + this.width <= 0){
                    this.position.shift();
                    score.value += 1;
                    score.best = Math.max(score.value, score.best);
                    localStorage.setItem("best", score.best);
                }
            }
        },
        reset: function(){
            this.position = [];
        }
    }

    const getReady = {
        draw: function(){
            if(state.current == state.getReady){
                ctx.fillStyle = "#FFF";
                ctx.font = "35px Teko";
                ctx.textAlign = "center";
                ctx.fillText("Tap to Play", canvas.width / 2, 150);
            }
        }
    }

    const gameOver = {
        draw: function(){
            if(state.current == state.over){
                ctx.fillStyle = "#FFF";
                ctx.font = "35px Teko";
                ctx.textAlign = "center";
                ctx.fillText("Game Over", canvas.width / 2, 150);
                ctx.fillText("Tap to Restart", canvas.width / 2, 200);
            }
        }
    }

    const score = {
        best: parseInt(localStorage.getItem("best")) || 0,
        value: 0,
        draw: function(){
            ctx.fillStyle = "#FFF";
            if(state.current == state.game){
                ctx.font = "35px Teko";
                ctx.fillText(this.value, canvas.width / 2, 50);
            } else if(state.current == state.over){
                ctx.font = "25px Teko";
                ctx.fillText("Score: " + this.value, canvas.width / 2, 186);
                ctx.fillText("Best: " + this.best, canvas.width / 2, 228);
            }
        },
        reset: function(){
            this.value = 0;
        }
    }

    function draw(){
        bg.draw();
        pipes.draw();
        fg.draw();
        bird.draw();
        getReady.draw();
        gameOver.draw();
        score.draw();
    }

    function update(){
        bird.update();
        fg.update();
        pipes.update();
    }

    function loop(){
        update();
        draw();
        frames++;
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
